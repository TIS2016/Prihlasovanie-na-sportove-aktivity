{% load static %}

<!DOCTYPE html>
<html lang="sk">
<head>

    <!-- Bootstrap core CSS -->
    <link href=" {% static 'web/css/bootstrap.css' %} " rel="stylesheet">
    <link href=" {% static 'web/css/jquery-ui.css' %} " rel="stylesheet">


    <title>{% block title %} {% endblock %}</title>

    {% block head-tag %}

    {% endblock %}

</head>

<body>

<!-- Modal -->
<div class="modal fade" id="getCodeModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"> NAHLAD TERMINU </h4>
            </div>
            <div class="modal-body" id="getCode" style="overflow-y: scroll;" >
                //ajax success content here.
                {{ pocet }}

            </div>
            <div class="form-group">
                <label for="comment">Poznamka pre odhlasenie:</label>
                <textarea class="form-control" rows="5" id="comment"></textarea>
            </div>
            <button type="button" class="btn btn-danger btn-lg" id="delete">Odhlasit</button>
        </div>
    </div>
</div>


<div class="page-container">
    <div class="container-fluid">
        {% block logo-buttons %}

        {% endblock %}

        {% block navigation %}

        {% endblock %}

        {% block termin-info %}

        {% endblock %}

        <script>
            var thisIsAnObject;

            function mod(n, m) {
                return ((n % m) + m) % m;
            }
            function getCrtfCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var windowObjectReference;
            var csrftoken = getCrtfCookie('csrftoken');

            // function which open particular day-lesson in new window
            function show_termin_info(id) {
                var dimensions = 'width=500,height=300,left=0,top=100,screenX=0,screenY=100';

                var day = id % 5;

                var datum = null;

                var array = document.getElementById('datepicker').value.split('/');
                // get 5 days of the week
                var d1 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d2 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d3 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d4 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d5 = Date.parse(array[1] + "." + array[0] + "." + array[2]);

                var md1 = d1.previous().monday();
                var md2 = d2.previous().monday();
                var md3 = d3.previous().monday();
                var md4 = d4.previous().monday();
                var md5 = d5.previous().monday();


                var dd1 = md1;
                var dd2 = md2.add(1).days();
                var dd3 = md3.add(2).days();
                var dd4 = md4.add(3).days();
                var dd5 = md5.add(4).days();

                switch (day) {
                    case 1:
                        datum = dd1;
                        console.log("pon", dd1);
                        break;
                    case 2:
                        datum = dd2;
                        console.log("ut", dd2);
                        break;
                    case 3:
                        datum = dd3;
                        console.log("streda", dd3);
                        break;
                    case 4:
                        datum = dd4;
                        console.log("stvrtok", dd4);
                        break;
                    case 0:
                        datum = dd5;
                        console.log("pia", dd5);
                        break;

                }

                $.ajax({
                    url: 'termin/' + id + '/',
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: csrftoken,
                        datum: datum,

                    },
                    success: function (json) {

                        thisIsAnObject = json['reservations'];

//                        if (windowObjectReference) {
//                            windowObjectReference.close();
//                        }
//                        windowObjectReference = window.open(this.url, 'termin_info', dimensions);


                        $("#getCode").html(json['pocet']);
                        $("#getCodeModal").modal('show');


                        var res = json['reservations'];
                        var capacity = json['capacity'];

                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error " + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                    }
                });
            }
        </script>


        {% block week-grid %}

        {% endblock %}

    </div>
</div>

</body>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>

<script src="{% static 'web/js/jquery-ui.js' %}"></script>

<script src="{% static 'web/js/date.js' %}"></script>

<!--<script src="{% static 'web/js/jquery.min.js' %}"></script>-->

<script src=" {% static 'web/js/bootstrap.min.js' %} "></script>
<!--IE10 viewport hack for Surface/desktop Windows 8 bug -->
{#
<script src=" {% static 'web/js/ie10-viewport-bug-workaround.js' %} "></script>
#}

{% block js %}

{% endblock %}

<script type="text/javascript">
    $(document).ready(function () {
        function mod(n, m) {
            return ((n % m) + m) % m;
        }

        // fnction to get csrftoken from cookies which is used to comunicate with wsgi protocol
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // jquery datepicker added to input text with id "datepicker"
        $(function () {

            $("#datepicker").datepicker({
                onSelect: function () {
                    $(this).change();
                }
                // when some date is selected then send request and re-render data
            }).on("change", function () {
                // parse datepicker's date
                var array = document.getElementById('datepicker').value.split('/')
                var d = new Date(array[2], array[1], array[0]);
                var day = mod((d.getDay() - 2), 7);
                // change old selected day --> red background to white
                for (var i = 1; i <= 110; i++) {
                    if (document.getElementById(i.toString()).style.backgroundColor == "red") {
                        document.getElementById(i.toString()).style.background = "white";
                    }
                }
                // again render red bg
                select_red_by_day(day);

                // get 5 days of the week
                var d1 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d2 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d3 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d4 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                var d5 = Date.parse(array[1] + "." + array[0] + "." + array[2]);
                if (d1.getDay() != 1) {
                    var md1 = d1.previous().monday();
                    var md2 = d2.previous().monday();
                    var md3 = d3.previous().monday();
                    var md4 = d4.previous().monday();
                    var md5 = d5.previous().monday();
                }
                else {
                    var md1 = d1;
                    var md2 = d2;
                    var md3 = d3;
                    var md4 = d4;
                    var md5 = d5;
                }
                var dd2 = md2.add(1).days();
                var dd3 = md3.add(2).days();
                var dd4 = md4.add(3).days();
                var dd5 = md5.add(4).days();
                // function which send request for data
                function get_db_data() {
                    var csrftoken = getCookie('csrftoken');
                    $.ajax({
                        url: window.location.href, // the endpoint,commonly same url
                        type: "POST", // http method
                        data: {
                            csrfmiddlewaretoken: csrftoken,
                            d1: md1,
                            d2: dd2,
                            d3: dd3,
                            d4: dd4,
                            d5: dd5,
                        },
                        // when success then get data from response and re-render data on page
                        success: function (json) {
                            alert(json['reservations'])
                            console.log(json);
                            var res = json['reservations'];
                            var capacity = json['capacity'];
                            for (var i = 0; i < res.length; i++) {
                                document.getElementById((i + 1).toString()).children[1].innerHTML = res[i] + "/" + capacity;
                            }
                        },
                        error: function (xhr, errmsg, err) {
                            console.log("Error " + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                        }
                    });
                }

                // fucntion call
                get_db_data();
            });
        });
        // this will set to input text current date
        var date_today = function () {
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();
            if (dd < 10) {
                dd = '0' + dd
            }
            if (mm < 10) {
                mm = '0' + mm
            }
            today = dd + '/' + mm + '/' + yyyy;
            return today;
        }
        document.getElementById('datepicker').value = date_today();

//----------------------------------------------------------------------------------------------------------------------------------------

        // this function executes when "Zrus" button clicked and change number of people in lesson
        $("#delete").click(function () {
            document.getElementById('1').children[1].innerHTML = "9/9";

        });

        // this function executes when "Uloz" button clicked and opened new window with pre-submit info
        $("#save").click(function () {
            var terminy = grab_checked();
            var postUrl = "terminy/"
            if (terminy != null) {
                $.post(postUrl, {termins_id: terminy}, function (response) {
                    window.open(postUrl, 'terminy', 'width=500,height=300,left=0,top=100,screenX=0,screenY=100').document.write(response);
                });
            }
        });


//----------------------------------------------------------------------------------------------------------------------------------------


        // this will grab checked checkboxes and will return id's of their div element
        function grab_checked() {
            var result = [];
            var divs = $('div[class="checkbox"]');
            var checked = 0;
            for (i = 0; i < divs.length; i++) {
                if (divs[i].children[0].checked) {
                    checked += 1;
                    result.push(divs[i].id);
                }
            }
            var resultString = checked + " out of " + divs.length + " checkboxes are checked";
            if (checked > 0) {
                $('#div').html(resultString);
                return result;
            } else {
                $('#div').html("No checkbox checked");
                return null;
            }
        }

        // next ( ">" ) button clicked increase value in input text
        $('#next').click(function () {
            var date = $('#datepicker').datepicker('getDate');
            date.setDate(date.getDate() + 1)
            $('#datepicker').datepicker("setDate", date);
            change_bg_color();
        });
        // previous ( "<" ) button clicked decrease value in input text
        $('#prev').click(function () {
            var date = $('#datepicker').datepicker('getDate');
            date.setDate(date.getDate() - 1)
            $('#datepicker').datepicker("setDate", date);
            change_bg_color();
        });

        function select_red_by_day(day) {

            if (day < 6 && day > 0) {
                var ix = 0;
                for (var i = 1; i <= 110; i++) {
                    if (Math.floor(i / day)) {
                        document.getElementById(i.toString()).style.background = "red";
                        day += 5;
                    }
                    else {
                        if (document.getElementById(i.toString()).style.backgroundColor == "red") {
                            if (ix % 2 == 0) {
                                document.getElementById(i.toString()).style.background = "#F9F9F9";
                            }
                            else {
                                document.getElementById(i.toString()).style.background = "white";
                            }
                            ix += 1;
                        }
                    }
                }
            }
            else {
                for (var i = 1; i <= 110; i++) {
                    if (document.getElementById(i.toString()).style.backgroundColor == "red") {
                        document.getElementById(i.toString()).style.background = "white";
                    }
                }
            }
        }
        ;

        function change_bg_color() {
            var new_date = $('#datepicker').datepicker('getDate');
            var day = new_date.getDay();
            select_red_by_day(day);
        }
        ;

        var rank = "admin";

        function logic_division() {
            for (var i = 1; i <= 110; i++) {
                if (rank == "student") {
                    if (i < 71) {
                        document.getElementById(i.toString()).style.background = "black";
                    }
                }
                else if (rank == "ucitel") {
                    if (i >= 71) {
                        document.getElementById(i.toString()).style.background = "black";
                    }
                }
            }
        }
        ;


        function do_stuff() {

            change_bg_color();
            logic_division();
        }
        ;
        window.onload = do_stuff;


    })
    ;
</script>

</html>